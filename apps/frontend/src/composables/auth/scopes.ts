export const scopeMessages = defineMessages({
  userReadEmailLabel: {
    id: "scopes.userReadEmail.label",
    defaultMessage: "邮箱读取",
  },
  userReadEmailDescription: {
    id: "scopes.userReadEmail.description",
    defaultMessage: "读取您的邮箱地址",
  },
  userReadLabel: {
    id: "scopes.userRead.label",
    defaultMessage: "用户信息读取",
  },
  userReadDescription: {
    id: "scopes.userRead.description",
    defaultMessage: "访问您的个人资料信息",
  },
  userWriteLabel: {
    id: "scopes.userWrite.label",
    defaultMessage: "用户信息修改",
  },
  userWriteDescription: {
    id: "scopes.userWrite.description",
    defaultMessage: "修改您的个人资料信息",
  },
  userDeleteLabel: {
    id: "scopes.userDelete.label",
    defaultMessage: "账户删除",
  },
  userDeleteDescription: {
    id: "scopes.userDelete.description",
    defaultMessage: "删除您的账户",
  },
  userAuthWriteLabel: {
    id: "scopes.userAuthWrite.label",
    defaultMessage: "登录信息修改",
  },
  userAuthWriteDescription: {
    id: "scopes.userAuthWrite.description",
    defaultMessage: "修改您的登录信息",
  },
  notificationReadLabel: {
    id: "scopes.notificationRead.label",
    defaultMessage: "通知读取",
  },
  notificationReadDescription: {
    id: "scopes.notificationRead.description",
    defaultMessage: "读取您的通知",
  },
  notificationWriteLabel: {
    id: "scopes.notificationWrite.label",
    defaultMessage: "通知修改",
  },
  notificationWriteDescription: {
    id: "scopes.notificationWrite.description",
    defaultMessage: "读取或删除您的通知",
  },
  payoutsReadLabel: {
    id: "scopes.payoutsRead.label",
    defaultMessage: "付款读取",
  },
  payoutsReadDescription: {
    id: "scopes.payoutsRead.description",
    defaultMessage: "读取您的账单信息",
  },
  payoutsWriteLabel: {
    id: "scopes.payoutsWrite.label",
    defaultMessage: "付款修改",
  },
  payoutsWriteDescription: {
    id: "scopes.payoutsWrite.description",
    defaultMessage: "提现收益",
  },
  analyticsLabel: {
    id: "scopes.analytics.label",
    defaultMessage: "数据分析读取",
  },
  analyticsDescription: {
    id: "scopes.analytics.description",
    defaultMessage: "读取您的数据分析",
  },
  projectCreateLabel: {
    id: "scopes.projectCreate.label",
    defaultMessage: "资源创建",
  },
  projectCreateDescription: {
    id: "scopes.projectCreate.description",
    defaultMessage: "创建新资源",
  },
  projectReadLabel: {
    id: "scopes.projectRead.label",
    defaultMessage: "资源读取",
  },
  projectReadDescription: {
    id: "scopes.projectRead.description",
    defaultMessage: "读取您所有资源的信息",
  },
  projectWriteLabel: {
    id: "scopes.projectWrite.label",
    defaultMessage: "资源修改",
  },
  projectWriteDescription: {
    id: "scopes.projectWrite.description",
    defaultMessage: "修改资源信息",
  },
  projectDeleteLabel: {
    id: "scopes.projectDelete.label",
    defaultMessage: "资源删除",
  },
  projectDeleteDescription: {
    id: "scopes.projectDelete.description",
    defaultMessage: "删除您的资源",
  },
  versionCreateLabel: {
    id: "scopes.versionCreate.label",
    defaultMessage: "版本发布",
  },
  versionCreateDescription: {
    id: "scopes.versionCreate.description",
    defaultMessage: "发布新的版本",
  },
  versionReadLabel: {
    id: "scopes.versionRead.label",
    defaultMessage: "版本读取",
  },
  versionReadDescription: {
    id: "scopes.versionRead.description",
    defaultMessage: "读取所有版本信息",
  },
  versionWriteLabel: {
    id: "scopes.versionWrite.label",
    defaultMessage: "版本修改",
  },
  versionWriteDescription: {
    id: "scopes.versionWrite.description",
    defaultMessage: "修改您的版本信息",
  },
  versionDeleteLabel: {
    id: "scopes.versionDelete.label",
    defaultMessage: "版本删除",
  },
  versionDeleteDescription: {
    id: "scopes.versionDelete.description",
    defaultMessage: "删除您的版本",
  },
  reportCreateLabel: {
    id: "scopes.reportCreate.label",
    defaultMessage: "举报创建",
  },
  reportCreateDescription: {
    id: "scopes.reportCreate.description",
    defaultMessage: "创建举报",
  },
  reportReadLabel: {
    id: "scopes.reportRead.label",
    defaultMessage: "举报读取",
  },
  reportReadDescription: {
    id: "scopes.reportRead.description",
    defaultMessage: "读取举报信息",
  },
  reportWriteLabel: {
    id: "scopes.reportWrite.label",
    defaultMessage: "举报修改",
  },
  reportWriteDescription: {
    id: "scopes.reportWrite.description",
    defaultMessage: "修改举报信息",
  },
  reportDeleteLabel: {
    id: "scopes.reportDelete.label",
    defaultMessage: "举报删除",
  },
  reportDeleteDescription: {
    id: "scopes.reportDelete.description",
    defaultMessage: "删除举报",
  },
  threadReadLabel: {
    id: "scopes.threadRead.label",
    defaultMessage: "对话读取",
  },
  threadReadDescription: {
    id: "scopes.threadRead.description",
    defaultMessage: "读取对话信息",
  },
  threadWriteLabel: {
    id: "scopes.threadWrite.label",
    defaultMessage: "对话修改",
  },
  threadWriteDescription: {
    id: "scopes.threadWrite.description",
    defaultMessage: "修改对话信息",
  },
  patCreateLabel: {
    id: "scopes.patCreate.label",
    defaultMessage: "PAT创建",
  },
  patCreateDescription: {
    id: "scopes.patCreate.description",
    defaultMessage: "创建个人访问令牌",
  },
  patReadLabel: {
    id: "scopes.patRead.label",
    defaultMessage: "PAT读取",
  },
  patReadDescription: {
    id: "scopes.patRead.description",
    defaultMessage: "读取已创建的的个人访问令牌信息",
  },
  patWriteLabel: {
    id: "scopes.patWrite.label",
    defaultMessage: "PAT 修改",
  },
  patWriteDescription: {
    id: "scopes.patWrite.description",
    defaultMessage: "修改个人访问令牌信息",
  },
  patDeleteLabel: {
    id: "scopes.patDelete.label",
    defaultMessage: "PAT 删除",
  },
  patDeleteDescription: {
    id: "scopes.patDelete.description",
    defaultMessage: "删除个人访问令牌",
  },
  sessionReadLabel: {
    id: "scopes.sessionRead.label",
    defaultMessage: "会话读取",
  },
  sessionReadDescription: {
    id: "scopes.sessionRead.description",
    defaultMessage: "读取活跃会话",
  },
  sessionDeleteLabel: {
    id: "scopes.sessionDelete.label",
    defaultMessage: "会话删除",
  },
  sessionDeleteDescription: {
    id: "scopes.sessionDelete.description",
    defaultMessage: "删除会话",
  },
  performAnalyticsLabel: {
    id: "scopes.performAnalytics.label",
    defaultMessage: "数据分析执行",
  },
  performAnalyticsDescription: {
    id: "scopes.performAnalytics.description",
    defaultMessage: "执行数据分析操作",
  },
  collectionCreateLabel: {
    id: "scopes.collectionCreate.label",
    defaultMessage: "收藏夹创建",
  },
  collectionCreateDescription: {
    id: "scopes.collectionCreate.description",
    defaultMessage: "创建收藏夹",
  },
  collectionReadLabel: {
    id: "scopes.collectionRead.label",
    defaultMessage: "收藏夹读取",
  },
  collectionReadDescription: {
    id: "scopes.collectionRead.description",
    defaultMessage: "读取收藏夹内容",
  },
  collectionWriteLabel: {
    id: "scopes.collectionWrite.label",
    defaultMessage: "收藏夹修改",
  },
  collectionWriteDescription: {
    id: "scopes.collectionWrite.description",
    defaultMessage: "修改收藏夹内容",
  },
  collectionDeleteLabel: {
    id: "scopes.collectionDelete.label",
    defaultMessage: "收藏夹删除",
  },
  collectionDeleteDescription: {
    id: "scopes.collectionDelete.description",
    defaultMessage: "删除收藏夹",
  },
  organizationCreateLabel: {
    id: "scopes.organizationCreate.label",
    defaultMessage: "组织创建",
  },
  organizationCreateDescription: {
    id: "scopes.organizationCreate.description",
    defaultMessage: "创建组织",
  },
  organizationReadLabel: {
    id: "scopes.organizationRead.label",
    defaultMessage: "组织读取",
  },
  organizationReadDescription: {
    id: "scopes.organizationRead.description",
    defaultMessage: "读取组织信息",
  },
  organizationWriteLabel: {
    id: "scopes.organizationWrite.label",
    defaultMessage: "组织修改",
  },
  organizationWriteDescription: {
    id: "scopes.organizationWrite.description",
    defaultMessage: "修改组织信息",
  },
  organizationDeleteLabel: {
    id: "scopes.organizationDelete.label",
    defaultMessage: "组织删除",
  },
  organizationDeleteDescription: {
    id: "scopes.organizationDelete.description",
    defaultMessage: "删除组织",
  },
  sessionAccessLabel: {
    id: "scopes.sessionAccess.label",
    defaultMessage: "会话访问",
  },
  sessionAccessDescription: {
    id: "scopes.sessionAccess.description",
    defaultMessage: "访问 Modrinth 提供的会话",
  },
});

const scopeDefinitions = [
  {
    id: "USER_READ_EMAIL",
    value: BigInt(1) << BigInt(0),
    label: scopeMessages.userReadEmailLabel,
    desc: scopeMessages.userReadEmailDescription,
  },
  {
    id: "USER_READ",
    value: BigInt(1) << BigInt(1),
    label: scopeMessages.userReadLabel,
    desc: scopeMessages.userReadDescription,
  },
  {
    id: "USER_WRITE",
    value: BigInt(1) << BigInt(2),
    label: scopeMessages.userWriteLabel,
    desc: scopeMessages.userWriteDescription,
  },
  {
    id: "USER_DELETE",
    value: BigInt(1) << BigInt(3),
    label: scopeMessages.userDeleteLabel,
    desc: scopeMessages.userDeleteDescription,
  },
  {
    id: "USER_AUTH_WRITE",
    value: BigInt(1) << BigInt(4),
    label: scopeMessages.userAuthWriteLabel,
    desc: scopeMessages.userAuthWriteDescription,
  },
  {
    id: "NOTIFICATION_READ",
    value: BigInt(1) << BigInt(5),
    label: scopeMessages.notificationReadLabel,
    desc: scopeMessages.notificationReadDescription,
  },
  {
    id: "NOTIFICATION_WRITE",
    value: BigInt(1) << BigInt(6),
    label: scopeMessages.notificationWriteLabel,
    desc: scopeMessages.notificationWriteDescription,
  },
  {
    id: "PAYOUTS_READ",
    value: BigInt(1) << BigInt(7),
    label: scopeMessages.payoutsReadLabel,
    desc: scopeMessages.payoutsReadDescription,
  },
  {
    id: "PAYOUTS_WRITE",
    value: BigInt(1) << BigInt(8),
    label: scopeMessages.payoutsWriteLabel,
    desc: scopeMessages.payoutsWriteDescription,
  },
  {
    id: "ANALYTICS",
    value: BigInt(1) << BigInt(9),
    label: scopeMessages.analyticsLabel,
    desc: scopeMessages.analyticsDescription,
  },
  {
    id: "PROJECT_CREATE",
    value: BigInt(1) << BigInt(10),
    label: scopeMessages.projectCreateLabel,
    desc: scopeMessages.projectCreateDescription,
  },
  {
    id: "PROJECT_READ",
    value: BigInt(1) << BigInt(11),
    label: scopeMessages.projectReadLabel,
    desc: scopeMessages.projectReadDescription,
  },
  {
    id: "PROJECT_WRITE",
    value: BigInt(1) << BigInt(12),
    label: scopeMessages.projectWriteLabel,
    desc: scopeMessages.projectWriteDescription,
  },
  {
    id: "PROJECT_DELETE",
    value: BigInt(1) << BigInt(13),
    label: scopeMessages.projectDeleteLabel,
    desc: scopeMessages.projectDeleteDescription,
  },
  {
    id: "VERSION_CREATE",
    value: BigInt(1) << BigInt(14),
    label: scopeMessages.versionCreateLabel,
    desc: scopeMessages.versionCreateDescription,
  },
  {
    id: "VERSION_READ",
    value: BigInt(1) << BigInt(15),
    label: scopeMessages.versionReadLabel,
    desc: scopeMessages.versionReadDescription,
  },
  {
    id: "VERSION_WRITE",
    value: BigInt(1) << BigInt(16),
    label: scopeMessages.versionWriteLabel,
    desc: scopeMessages.versionWriteDescription,
  },
  {
    id: "VERSION_DELETE",
    value: BigInt(1) << BigInt(17),
    label: scopeMessages.versionDeleteLabel,
    desc: scopeMessages.versionDeleteDescription,
  },
  {
    id: "REPORT_CREATE",
    value: BigInt(1) << BigInt(18),
    label: scopeMessages.reportCreateLabel,
    desc: scopeMessages.reportCreateDescription,
  },
  {
    id: "REPORT_READ",
    value: BigInt(1) << BigInt(19),
    label: scopeMessages.reportReadLabel,
    desc: scopeMessages.reportReadDescription,
  },
  {
    id: "REPORT_WRITE",
    value: BigInt(1) << BigInt(20),
    label: scopeMessages.reportWriteLabel,
    desc: scopeMessages.reportWriteDescription,
  },
  {
    id: "REPORT_DELETE",
    value: BigInt(1) << BigInt(21),
    label: scopeMessages.reportDeleteLabel,
    desc: scopeMessages.reportDeleteDescription,
  },
  {
    id: "THREAD_READ",
    value: BigInt(1) << BigInt(22),
    label: scopeMessages.threadReadLabel,
    desc: scopeMessages.threadReadDescription,
  },
  {
    id: "THREAD_WRITE",
    value: BigInt(1) << BigInt(23),
    label: scopeMessages.threadWriteLabel,
    desc: scopeMessages.threadWriteDescription,
  },
  {
    id: "PAT_CREATE",
    value: BigInt(1) << BigInt(24),
    label: scopeMessages.patCreateLabel,
    desc: scopeMessages.patCreateDescription,
  },
  {
    id: "PAT_READ",
    value: BigInt(1) << BigInt(25),
    label: scopeMessages.patReadLabel,
    desc: scopeMessages.patReadDescription,
  },
  {
    id: "PAT_WRITE",
    value: BigInt(1) << BigInt(26),
    label: scopeMessages.patWriteLabel,
    desc: scopeMessages.patWriteDescription,
  },
  {
    id: "PAT_DELETE",
    value: BigInt(1) << BigInt(27),
    label: scopeMessages.patDeleteLabel,
    desc: scopeMessages.patDeleteDescription,
  },
  {
    id: "SESSION_READ",
    value: BigInt(1) << BigInt(28),
    label: scopeMessages.sessionReadLabel,
    desc: scopeMessages.sessionReadDescription,
  },
  {
    id: "SESSION_DELETE",
    value: BigInt(1) << BigInt(29),
    label: scopeMessages.sessionDeleteLabel,
    desc: scopeMessages.sessionDeleteDescription,
  },
  {
    id: "PERFORM_ANALYTICS",
    value: BigInt(1) << BigInt(30),
    label: scopeMessages.performAnalyticsLabel,
    desc: scopeMessages.performAnalyticsDescription,
  },
  {
    id: "COLLECTION_CREATE",
    value: BigInt(1) << BigInt(31),
    label: scopeMessages.collectionCreateLabel,
    desc: scopeMessages.collectionCreateDescription,
  },
  {
    id: "COLLECTION_READ",
    value: BigInt(1) << BigInt(32),
    label: scopeMessages.collectionReadLabel,
    desc: scopeMessages.collectionReadDescription,
  },
  {
    id: "COLLECTION_WRITE",
    value: BigInt(1) << BigInt(33),
    label: scopeMessages.collectionWriteLabel,
    desc: scopeMessages.collectionWriteDescription,
  },
  {
    id: "COLLECTION_DELETE",
    value: BigInt(1) << BigInt(34),
    label: scopeMessages.collectionDeleteLabel,
    desc: scopeMessages.collectionDeleteDescription,
  },
  {
    id: "ORGANIZATION_CREATE",
    value: BigInt(1) << BigInt(35),
    label: scopeMessages.organizationCreateLabel,
    desc: scopeMessages.organizationCreateDescription,
  },
  {
    id: "ORGANIZATION_READ",
    value: BigInt(1) << BigInt(36),
    label: scopeMessages.organizationReadLabel,
    desc: scopeMessages.organizationReadDescription,
  },
  {
    id: "ORGANIZATION_WRITE",
    value: BigInt(1) << BigInt(37),
    label: scopeMessages.organizationWriteLabel,
    desc: scopeMessages.organizationWriteDescription,
  },
  {
    id: "ORGANIZATION_DELETE",
    value: BigInt(1) << BigInt(38),
    label: scopeMessages.organizationDeleteLabel,
    desc: scopeMessages.organizationDeleteDescription,
  },
  {
    id: "SESSION_ACCESS",
    value: BigInt(1) << BigInt(39),
    label: scopeMessages.sessionAccessLabel,
    desc: scopeMessages.sessionAccessDescription,
  },
];

const Scopes = scopeDefinitions.reduce(
  (acc, scope) => {
    acc[scope.id] = scope.value;
    return acc;
  },
  {} as Record<string, bigint>,
);

export const restrictedScopes = [
  Scopes.PAT_READ,
  Scopes.PAT_CREATE,
  Scopes.PAT_WRITE,
  Scopes.PAT_DELETE,
  Scopes.SESSION_READ,
  Scopes.SESSION_DELETE,
  Scopes.SESSION_ACCESS,
  Scopes.USER_AUTH_WRITE,
  Scopes.USER_DELETE,
  Scopes.PERFORM_ANALYTICS,
];

export const scopeList = Object.entries(Scopes)
  .filter(([_, value]) => !restrictedScopes.includes(value))
  .map(([key, _]) => key);

export const getScopeValue = (scope: string) => {
  return Scopes[scope];
};

export const encodeScopes = (scopes: string[]) => {
  let scopeFlag = BigInt(0);

  // We iterate over the provided scopes
  for (const scope of scopes) {
    // We iterate over the entries of the Scopes object
    for (const [scopeName, scopeFlagValue] of Object.entries(Scopes)) {
      // If the scope name is the same as the provided scope, add the scope flag to the scopeFlag variable
      if (scopeName === scope) {
        scopeFlag = scopeFlag | scopeFlagValue;
      }
    }
  }

  return scopeFlag;
};

export const decodeScopes = (scopes: bigint | number) => {
  if (typeof scopes === "number") {
    scopes = BigInt(scopes);
  }

  const authorizedScopes = [];

  // We iterate over the entries of the Scopes object
  for (const [scopeName, scopeFlag] of Object.entries(Scopes)) {
    // If the scope flag is present in the provided number, add the scope name to the list
    if ((scopes & scopeFlag) === scopeFlag) {
      authorizedScopes.push(scopeName);
    }
  }

  return authorizedScopes;
};

export const hasScope = (scopes: bigint, scope: string) => {
  const authorizedScopes = decodeScopes(scopes);
  return authorizedScopes.includes(scope);
};

export const toggleScope = (scopes: bigint, scope: string) => {
  const authorizedScopes = decodeScopes(scopes);
  if (authorizedScopes.includes(scope)) {
    return encodeScopes(authorizedScopes.filter((authorizedScope) => authorizedScope !== scope));
  } else {
    return encodeScopes([...authorizedScopes, scope]);
  }
};

export const useScopes = () => {
  const {formatMessage} = useVIntl();

  const scopesToDefinitions = (scopes: bigint) => {
    const authorizedScopes = decodeScopes(scopes);
    return authorizedScopes.map((scope) => {
      const scopeDefinition = scopeDefinitions.find(
        (scopeDefinition) => scopeDefinition.id === scope,
      );
      if (!scopeDefinition) {
        throw new Error(`Scope ${scope} not found`);
      }
      return formatMessage(scopeDefinition.desc);
    });
  };

  const scopesToLabels = (scopes: bigint) => {
    const authorizedScopes = decodeScopes(scopes);
    return authorizedScopes.map((scope) => {
      const scopeDefinition = scopeDefinitions.find(
        (scopeDefinition) => scopeDefinition.id === scope,
      );
      if (!scopeDefinition) {
        throw new Error(`Scope ${scope} not found`);
      }
      return formatMessage(scopeDefinition.label);
    });
  };

  return {
    scopesToDefinitions,
    scopesToLabels,
  };
};
